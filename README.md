# gRPCtoJakartaREST_archetype

The [RESTEasy grpc-bridge facility](https://github.com/resteasy/resteasy)
supports exposing Jakarta RESTful Web Services resources to gRPC clients. See the 
[RESTEasy User Guide](https://resteasy.dev/docs/) for a more detailed
discussion of the various mechanisms and classes involved.

There are a number of pieces to create, and this maven archetype includes a pom.xml which 
incorporates the steps necessary to create them.

## Using the archetype

gRPCtoJakartaREST_archetype takes the GAV of an existing Jakarta RESTful Web Services project, called the **target project**,
and creates a new project which can generate a WAR with a copy of the target project plus all of the pieces
needed for a gRPC client to interface with the copy of the target project. We will refer to the generated project as the corresponding **gRPC bridge project**.

### Creating the gRPC bridge project

To create a gRPC bridge project from an existing project, the archetype needs several 
pieces of information:

 1. the GAV of the target project

 2. the intended GAV of the gRPC bridge project

 3. "generate-prefix" parameter: the prefix to use for names of generated classes

 4. "generate-package" parameter: the Java package to use for generated classes

 5. "resteasy-version" parameter

For example,

        mvn archetype:generate \
          -DarchetypeGroupId=org.jboss.resteasy -DarchetypeArtifactId=gRPCtoJakartaREST-archetype -DarchetypeVersion=0.0.3-SNAPSHOT \
          -DgroupId=jakarta.rest.example -DartifactId=jakarta.rest.example -Dversion=0.0.2-SNAPSHOT \
          -Dgenerate-prefix=CC1 -Dgenerate-package=jakarta.rest.example -Dresteasy-version=6.2.2.Final

See [https://github.com/resteasy/jakarta.rest.example](https://github.com/resteasy/jakarta.rest.example) 
for the sample code mentioned here.

The result is a new gRPC bridge maven project named by its artifactId. Its initial contents are

 1. pom.xml
  
 2. a Jakarta RESTful Web Services resource class named `<generate-prefix>_Server`
 
 3. a web.xml file with suggested builtin Jakarta REST provider configuration
 
 4. an empty beans.xml file

 5. a *buildjar* shell script which can package all of the necessary files in a JAR file
 
 6. a *deployjar* shell script which can deploy the JAR file
 
### Building the gRPC bridge project

Building the gRPC bridge project downloads the contents of the target 
project and builds all of the generated classes described in the
[RESTEasy User Guide](https://resteasy.dev/docs/).

The following parameter is required:
 
 1. servlet.name: the name of the servlet managing the generated WAR

The following parameters are optional:

 2. classes: necessary entity / response classes not detected by the heuristic in `org.jboss.resteasy.grpc.protobuf.JavaToProtobufGenerator`
    in grpc-bridge
    
 3. "inWildfly": "true" if and only if the gRPC bridge willl run in a version of WildFly supplied with the grpc subsystem. Defaults to "true".

The "classes" parameter has the syntax

    (source-directory ':' fully-qualified-name) [',' source-directory ':' fully-qualified-name]*
 
For example,

     mvn -Dservlet.name=org.jboss.resteasy.example.ExampleApp \
         -Dclasses=/home/bob/project/jakarta.rest.example.grpc/jakarta.rest.example/src/main/java:org.jboss.resteasy.example.CC7,/home/bob/project/jakarta.rest.example.grpc/jakarta.rest.example/src/main/java:org.jboss.resteasy.example.CC6 \
         clean install
        
The gRPC bridge project will be populated as follows

 1. the src directory will be copied from the target project
 
 2. src/main/proto will hold the `<generate-prefix>.proto` file (generated by `org.jboss.resteasy.grpc.protobuf.JavaToProtobufGenerator`)
 
 3. target/generated-sources/protobuf/java will hold `<generate-prefix>_proto.java`, compiled 
    from `<generate-prefix>.proto`
    
 4. target/generated-sources/protobuf/grpc-java will hold the following generated classes:
 
    A. `<generate-prefix>ServiceGrpc.java` (generated by the gRPC plugin to the protobuf compiler)
    
    B. `<generate-prefix>ServiceGrpcImpl.java` (generated by `org.jboss.resteasy.grpc.ServiceGrpcExtender`)
    
    C. `<generate-prefix>JavabufTranslator.java` (generated by `org.jboss.resteasy.grpc.protobuf.JavabufTranslatorGenerator`)
    
    D. `<generate-prefix>MessageBodyReaderWriter.java` (generated by `org.jboss.resteasy.grpc.protobuf.ReaderWriterGenerator`)
    
 5. src/test/java will hold `org.jboss.resteasy.grpc.server.<generate-prefix>_Server.java`
    
The principal output is a WAR in the target directory which can be deployed to WildFly.

## Using the Web Archive

If "inWildfly" is set to "false" or the WAR is deployed to some environment other than WildFly with the grpc subsystem, the
class `<generate-prefix>_Server` is a Jakarta RESTful Web Services resource that can be used to start up a gRPC server 
upon receiving an invocation on path "grpcserver/start".
        
Once the gRPC server is started, the Jakarta RESTful Web Services resources in the gRPC bridge project (copied from the
target project) can be invoked by an appropriate gRPC client. For some sample client code, see
`org.jboss.resteasy.test.grpc.GrpcToJakartaRestTest` in RESTEasy's grpc-test module.

**Note.**

`<generate-prefix>ServiceGrpcImpl` retrieves the `org.jboss.resteasy.plugins.server.servlet.HttpServletDispatcher`
that handles the servlet. For this to work, there has to be a Jakarta RESTful Web Services call (as opposed to a gRPC call)
to any resource method in the WAR. Once that happens, gRPC calls will succeed.

For example, the @BeforeClass method in GrpcToJakartaRestTest includes the code

        Client client = ClientBuilder.newClient();
        client.target("http://localhost:8080/GrpcToJakartaRESTTest/grpcToJakartaRest/grpcserver/context").request().get();

Alternatively, the call can be made from a browser or by cURL.
