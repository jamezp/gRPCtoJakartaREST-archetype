# gRPCtoJAXRS_archetype

The [RESTEasy grpc-bridge facility](https://github.com/resteasy/resteasy) [UPDATE URL]
supports exposing Jakarta RESTful Web Services resources to gRPC clients. See the 
[RESTEasy User Guide](https://resteasy.dev/docs/) for a more detailed
discussion of the various mechanisms and classes involved.

There are a number of pieces to create, and this maven archetype includes a pom.xml which 
incorporates the steps necessary to create them.

## Using the archetype

gRPCtoJAXRS_archetype takes the GAV of an existing Jakarta RESTful Web Services project, called the **target project**,
and creates a new project which can generate a WAR with all of the pieces needed to interface between a gRPC client 
and a copy of the target project. We will refer to the generated project as the corresponding
**gRPCtoJkRWS project**.

### Creating the gRPCtoJkRWS project

To create a gRPCtoJkRWS project from an existing project, the archetype needs several 
pieces of information:

 1. the GAV of the target project

 2. the intended GAV of the gRPCtoJkRWS project

 3. "generate-prefix" parameter: the prefix to use for names of generated classes

 4. "generate-package" parameter: the Java package to use for generated classes

 5. "resteasy-version" parameter

For example,

        mvn archetype:generate \
          -DarchetypeGroupId=org.jboss.resteasy -DarchetypeArtifactId=gRPCtoJAXRS-archetype -DarchetypeVersion=0.0.3-SNAPSHOT \
          -DgroupId=jaxrs.example -DartifactId=jaxrs.example -Dversion=0.0.2-SNAPSHOT \
          -Dgenerate-prefix=CC1 -Dgenerate-package=jaxrs.example

See [jaxrs.example:jaxrs.example:0.0.2-SNAPSHOT](https://github.com/ronsigal/jaxrs-example) 
for the sample code mentioned here.

The result is a new gRPCtoJkRWS maven project named by its artifactId. Its initial contents are

 1. pom.xml
  
 2. a Jakarta RESTful Web Services resource class named `<generate-prefix>_Server`
 
 3. an empty beans.xml file

 4. a buildjar shell script which can package all of the necessary files in a JAR file [may go away]
 
### Building the gRPCtoJkRWS project

Building the gRPCtoJkRWS project downloads the contents of the target 
project and builds all of the generated classes described in the
[RESTEasy User Guide](https://resteasy.dev/docs/).

The following parameter is required:
 
 1. servlet.name: the name of the servlet managing the generated WAR

The following parameters are optional:

 2. extra.classes: necessary entity / response classes not detected by the heuristic in `org.jboss.resteasy.grpc.protobuf.JavaToProtobufGenerator`
    in grpc-bridge
    
 3. "inWildfly": "true" if and only if the gRPCtoJkRWS willl run in a version of WildFly supplied with the grpc subsystem. Defaults to "true".

The "extra.classes" parameter has the syntax

    (source-directory fully-qualified-name) [',' source-directory fully-qualified-name]*
 
For example,

     mvn -Dservlet.name=org.jboss.resteasy.example.ExampleApp \
         -Dextra.classes=/home/rsigal/tmp/grpc.050922/git.jaxrs.example.grpc/jaxrs.example/src/main/java:org.jboss.resteasy.example.CC7,/home/rsigal/tmp/grpc.050922/git.jaxrs.example.grpc/jaxrs.example/src/main/java:org.jboss.resteasy.example.CC6 \
         clean install
        
The gRPCtoJkRWS project will be populated as follows

 1. the src directory will be copied from the target project
 
 2. src/main/proto will hold the `<generate-prefix>.proto` file
 
 3. target/generated-sources/protobuf/java will hold `<generate-prefix>_proto.java`, compiled 
    from `<generate-prefix>.proto`
    
 4. target/generated-sources/protobuf/grpc-java will hold the following generated classes:
 
    A. `<generate-prefix>ServiceGrpc.java` (generated by the proto compiler gRPC plugin)
    
    B. `<generate-prefix>ServiceGrpcImpl.java` (generated by `org.jboss.resteasy.grpc.JaxrsImplBaseExtender`)
    
    C. `<generate-prefix>_JavabufTranslator.java` (generated by `org.jboss.resteasy.grpc.protobuf.JavabufTranslatorGenerator`)
    
    D. `<generate-prefix>MessageBodyReaderWriter.java` (generated by `org.jboss.resteasy.grpc.protobuf.ReaderWriterGenerator`)
    
 5. src/test/java will hold `org.jboss.resteasy.grpc.server.<generate-prefix>_Server.java`
    
The principal output is a WAR in the target directory which can be deployed to WildFly.

## Using the Web Archive

If the parameter "inWildfly" is set to "true", then `<generate-prefix>ServiceGrpcImpl` will be generated with the
annotation `@org.wildfly.grpc.GrpcService` from the WildFly grpc subsystem. That annotation allows the grpc subsystem
to discover the gRPCtoJkRWS WAR and associate it with the grpc port.

If "inWildfly" is set to "false" or the WAR is deployed to some environment other than WildFly with the grpc subsystem, the
class `<generate-prefix>_Server` is a Jakarta RESTful Web Services resource that can be used to start up a gRPC server 
upon receiving an invocation on path "grpcserver/start". For example,

        http://localhost:8080/jaxrs.example.grpc-0.0.2-SNAPSHOT/root/grpcserver/start
        
(where "root" is defined by @ApplicationPath("root") in `org.jboss.resteasy.example.ExampleApp`).
        
Once the gRPC server is started, the Jakarta RESTful Web Services resources in the gRPCtoJkRWS project (copied from the
target project) can be invoked by an appropriate gRPC client. For some sample client code, see
`org.jboss.resteasy.test.grpc.GrpcToJaxrsTest` in RESTEasy's integrated-test module.

**Note.**

`<generate-prefix>ServiceGrpcImpl` retrieves the `org.jboss.resteasy.plugins.server.servlet.HttpServletDispatcher`
that handles the servlet. For this to work, there has to be a Jakarta RESTful Web Services call (as opposed to a gRPC call)
to any resource method in the WAR. Once that happens, gRPC calls will succeed.

For example, the @BeforeClass method in GrpcToJaxrsTest includes the code

     Client client = ClientBuilder.newClient();
     Response response = client.target(generateURL("/p/context")).request().get();
     Assert.assertEquals(200, response.getStatus());

Alternatively, the call can be made from a browser or by cURL.
